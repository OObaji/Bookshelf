<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Book & Mentor Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1568667256549-094345857637?q=80&w=1915&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        #spotlight-overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle 350px at var(--x, 50%) var(--y, 50%), rgba(0,0,0,0) 0%, rgba(0,0,0,0.8) 80%);
            pointer-events: none;
            z-index: 1;
        }
        #app, #auth-section {
            position: relative;
            z-index: 2;
        }
        .card-enter {
            animation: card-enter 0.5s ease-out;
        }
        @keyframes card-enter {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        #toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        .nav-btn.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        .filter-btn.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            border-color: #4f46e5;
        }
        #bible-text-content p {
            margin-bottom: 1rem;
        }
        #bible-text-content sup {
            font-weight: bold;
            color: #4f46e5;
        }
        #bible-text-content mark {
            background-color: #fef08a; /* yellow-200 */
            cursor: pointer;
            border-radius: 2px;
        }
        #highlight-popover {
            position: absolute;
            display: none;
            z-index: 100;
        }
        .scripture-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .scripture-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="spotlight-overlay"></div>

    <!-- Authentication Section -->
    <section id="auth-section" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <!-- Login Form -->
            <div id="login-form" class="bg-white/90 backdrop-blur-sm p-8 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Login</h2>
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="login-email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" required>
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="login-password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" required>
                </div>
                <button id="login-btn" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Login</button>
                <p class="text-center text-sm text-gray-600 mt-4">
                    Don't have an account? <a href="#" id="show-register" class="font-medium text-indigo-600 hover:text-indigo-500">Register here</a>
                </p>
            </div>

            <!-- Register Form -->
            <div id="register-form" class="hidden bg-white/90 backdrop-blur-sm p-8 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Create Account</h2>
                <div class="mb-4">
                    <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="register-email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" required>
                </div>
                <div class="mb-6">
                    <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="register-password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" required>
                </div>
                <button id="register-btn" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Register</button>
                <p class="text-center text-sm text-gray-600 mt-4">
                    Already have an account? <a href="#" id="show-login" class="font-medium text-indigo-600 hover:text-indigo-500">Login here</a>
                </p>
            </div>
        </div>
    </section>

    <!-- Main App Section -->
    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 hidden">
        <!-- Header -->
        <header class="mb-8 text-center py-4 rounded-lg bg-black/20 flex justify-between items-center">
            <div></div> <!-- Spacer -->
            <div>
                <h1 class="text-4xl font-bold text-white">Book & Mentor Tracker</h1>
                <p class="text-lg text-gray-200 mt-2">Your personal library and wisdom hub, powered by AI.</p>
            </div>
            <button id="logout-btn" class="bg-red-600 text-white px-4 py-2 mr-4 rounded-lg font-semibold hover:bg-red-700 transition-colors">Logout</button>
        </header>

        <!-- Navigation -->
        <nav class="flex justify-center mb-8 bg-white/90 backdrop-blur-sm p-2 rounded-lg shadow-md">
            <button id="books-tab" class="nav-btn px-6 py-2 text-lg font-medium rounded-md focus:outline-none active">Books</button>
            <button id="mentors-tab" class="nav-btn px-6 py-2 text-lg font-medium text-gray-700 hover:bg-gray-200 rounded-md focus:outline-none ml-4">Mentors</button>
            <button id="scriptures-tab" class="nav-btn px-6 py-2 text-lg font-medium text-gray-700 hover:bg-gray-200 rounded-md focus:outline-none ml-4">Scriptures</button>
        </nav>

        <!-- Books Section -->
        <main id="books-section">
            <!-- Book Search Bar -->
            <div class="mb-8 p-6 bg-white/90 backdrop-blur-sm rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Find Your Next Read</h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="book-search-input" placeholder="e.g., 'Generate 5 psychology books'" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    <button id="book-search-btn" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors duration-300 flex items-center justify-center w-full sm:w-auto">
                        <svg class="search-icon h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                        <svg class="loading-spinner animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <span class="search-btn-text">Search</span>
                    </button>
                </div>
            </div>
            <!-- Book Categories Section -->
            <div class="mb-8 p-6 bg-white/90 backdrop-blur-sm rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Categories</h2>
                <div id="book-category-filters" class="flex flex-wrap gap-2"></div>
            </div>
            <!-- Book List -->
            <div id="book-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </main>

        <!-- Mentors Section -->
        <main id="mentors-section" class="hidden">
             <!-- Mentor Search Bar -->
            <div class="mb-8 p-6 bg-white/90 backdrop-blur-sm rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Find Your Mentors</h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="mentor-search-input" placeholder="e.g., 'add 5 mentors in technology'" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    <button id="mentor-search-btn" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors duration-300 flex items-center justify-center w-full sm:w-auto">
                        <svg class="search-icon h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                        <svg class="loading-spinner animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <span class="search-btn-text">Search</span>
                    </button>
                </div>
            </div>
            <!-- Mentor Fields Section -->
            <div class="mb-8 p-6 bg-white/90 backdrop-blur-sm rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Fields</h2>
                <div id="mentor-field-filters" class="flex flex-wrap gap-2"></div>
            </div>
            <!-- Mentor List -->
            <div id="mentor-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </main>
        
        <!-- Scriptures Section -->
        <main id="scriptures-section" class="hidden">
            <div class="p-6 bg-white/90 backdrop-blur-sm rounded-lg shadow-md">
                <!-- Scripture Navigation Header -->
                <div class="flex justify-between items-center mb-6">
                    <button id="bible-back-btn" class="hidden bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                        &larr; Back
                    </button>
                    <h2 id="scripture-view-title" class="text-2xl font-semibold text-gray-800 text-center flex-grow">The Bible</h2>
                    <div>
                        <label for="bible-version-select" class="sr-only">Version</label>
                        <select id="bible-version-select" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none bg-white">
                            <option value="kjv">King James Version</option>
                            <option value="web">World English Bible</option>
                            <option value="bbe">Bible in Basic English</option>
                        </select>
                    </div>
                </div>

                <!-- Book Grid -->
                <div id="bible-book-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    <!-- Book cards will be generated here -->
                </div>

                <!-- Chapter Grid -->
                <div id="bible-chapter-grid" class="hidden grid grid-cols-5 md:grid-cols-10 lg:grid-cols-12 gap-2">
                    <!-- Chapter cards will be generated here -->
                </div>

                <!-- Bible Text Display -->
                <div id="bible-text-container" class="hidden mt-4 p-6 bg-gray-50 rounded-lg border relative">
                    <div id="bible-text-content" class="text-gray-800 leading-relaxed">
                        <!-- Bible text will be loaded here -->
                    </div>
                    <!-- Highlight Popover -->
                    <div id="highlight-popover" class="bg-white rounded-md shadow-lg border">
                         <button id="highlight-btn" class="text-sm px-3 py-1 text-gray-700 hover:bg-gray-100 w-full text-left">Highlight</button>
                         <button id="remove-highlight-btn" class="text-sm px-3 py-1 text-red-600 hover:bg-gray-100 w-full text-left">Remove</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Book Modal -->
    <div id="edit-book-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6">Edit Book</h2>
            <input type="hidden" id="edit-book-id">
            <div class="mb-4"><label for="edit-book-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label><input type="text" id="edit-book-title" class="w-full p-2 border border-gray-300 rounded-lg"></div>
            <div class="mb-4"><label for="edit-book-author" class="block text-sm font-medium text-gray-700 mb-1">Author</label><input type="text" id="edit-book-author" class="w-full p-2 border border-gray-300 rounded-lg"></div>
            <div class="mb-4"><label for="edit-book-genre" class="block text-sm font-medium text-gray-700 mb-1">Genre/Field</label><input type="text" id="edit-book-genre" class="w-full p-2 border border-gray-300 rounded-lg"></div>
            <div class="mb-4"><label for="edit-book-topic" class="block text-sm font-medium text-gray-700 mb-1">Topic</label><input type="text" id="edit-book-topic" class="w-full p-2 border border-gray-300 rounded-lg"></div>
            <div class="mb-6"><label for="edit-book-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label><textarea id="edit-book-description" class="w-full p-2 border border-gray-300 rounded-lg" rows="3"></textarea></div>
            <div class="flex justify-end gap-4"><button id="cancel-edit-book-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancel</button><button id="save-edit-book-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save Changes</button></div>
        </div>
    </div>

    <!-- Edit Mentor Modal -->
    <div id="edit-mentor-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6">Edit Mentor</h2>
            <input type="hidden" id="edit-mentor-id">
            <div class="mb-4"><label for="edit-mentor-name" class="block text-sm font-medium text-gray-700 mb-1">Name</label><input type="text" id="edit-mentor-name" class="w-full p-2 border border-gray-300 rounded-lg"></div>
            <div class="mb-4"><label for="edit-mentor-field" class="block text-sm font-medium text-gray-700 mb-1">Field</label><input type="text" id="edit-mentor-field" class="w-full p-2 border border-gray-300 rounded-lg"></div>
            <div class="mb-6"><label for="edit-mentor-bio" class="block text-sm font-medium text-gray-700 mb-1">Bio</label><textarea id="edit-mentor-bio" class="w-full p-2 border border-gray-300 rounded-lg" rows="3"></textarea></div>
            <div class="flex justify-end gap-4"><button id="cancel-edit-mentor-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancel</button><button id="save-edit-mentor-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save Changes</button></div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
            <h2 class="text-xl font-bold mb-4">Are you sure?</h2>
            <p id="confirm-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-center gap-4"><button id="cancel-confirm-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancel</button><button id="confirm-action-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button></div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <p id="toast-message"></p>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, deleteDoc, updateDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAOplrEu4WR-0yXpso9kvcU7Ddelj2jK4k",
            authDomain: "bookshelf-68aef.firebaseapp.com",
            projectId: "bookshelf-68aef",
            storageBucket: "bookshelf-68aef.firebasestorage.app",
            messagingSenderId: "61108939848",
            appId: "1:61108939848:web:1d1f171b01f0450e51bc7d",
            measurementId: "G-PY2BXNC650"
        };
        
        // --- Firebase Init ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Global State ---
        let userId = null;
        let booksCollectionRef, mentorsCollectionRef, highlightsCollectionRef;
        let unsubscribeBooks, unsubscribeMentors;
        let allBooks = [], allMentors = [];
        let confirmAction = null;
        let currentHighlightTarget = null;
        let scriptureState = { view: 'books', book: null, chapter: null };

        // --- UI Elements ---
        const mainAppSection = document.getElementById('app');
        const authSection = document.getElementById('auth-section');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const spotlight = document.getElementById('spotlight-overlay');
        const booksTab = document.getElementById('books-tab');
        const mentorsTab = document.getElementById('mentors-tab');
        const scripturesTab = document.getElementById('scriptures-tab');
        const booksSection = document.getElementById('books-section');
        const mentorsSection = document.getElementById('mentors-section');
        const scripturesSection = document.getElementById('scriptures-section');
        // Book UI
        const bookSearchInput = document.getElementById('book-search-input');
        const bookSearchBtn = document.getElementById('book-search-btn');
        const bookCategoryFilters = document.getElementById('book-category-filters');
        const bookList = document.getElementById('book-list');
        // Mentor UI
        const mentorSearchInput = document.getElementById('mentor-search-input');
        const mentorSearchBtn = document.getElementById('mentor-search-btn');
        const mentorFieldFilters = document.getElementById('mentor-field-filters');
        const mentorList = document.getElementById('mentor-list');
        // Scripture UI
        const bibleVersionSelect = document.getElementById('bible-version-select');
        const bibleBookGrid = document.getElementById('bible-book-grid');
        const bibleChapterGrid = document.getElementById('bible-chapter-grid');
        const bibleTextContainer = document.getElementById('bible-text-container');
        const scriptureViewTitle = document.getElementById('scripture-view-title');
        const bibleBackBtn = document.getElementById('bible-back-btn');
        const bibleTextContent = document.getElementById('bible-text-content');
        const highlightPopover = document.getElementById('highlight-popover');
        const highlightBtn = document.getElementById('highlight-btn');
        const removeHighlightBtn = document.getElementById('remove-highlight-btn');
        // Modals & Toast
        const editBookModal = document.getElementById('edit-book-modal');
        const editMentorModal = document.getElementById('edit-mentor-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');

        // --- Bible Data ---
        const bibleBooks = { "Genesis": 50, "Exodus": 40, "Leviticus": 27, "Numbers": 36, "Deuteronomy": 34, "Joshua": 24, "Judges": 21, "Ruth": 4, "1 Samuel": 31, "2 Samuel": 24, "1 Kings": 22, "2 Kings": 25, "1 Chronicles": 29, "2 Chronicles": 36, "Ezra": 10, "Nehemiah": 13, "Esther": 10, "Job": 42, "Psalms": 150, "Proverbs": 31, "Ecclesiastes": 12, "Song of Solomon": 8, "Isaiah": 66, "Jeremiah": 52, "Lamentations": 5, "Ezekiel": 48, "Daniel": 12, "Hosea": 14, "Joel": 3, "Amos": 9, "Obadiah": 1, "Jonah": 4, "Micah": 7, "Nahum": 3, "Habakkuk": 3, "Zephaniah": 3, "Haggai": 2, "Zechariah": 14, "Malachi": 4, "Matthew": 28, "Mark": 16, "Luke": 24, "John": 21, "Acts": 28, "Romans": 16, "1 Corinthians": 16, "2 Corinthians": 13, "Galatians": 6, "Ephesians": 6, "Philippians": 4, "Colossians": 4, "1 Thessalonians": 5, "2 Thessalonians": 3, "1 Timothy": 6, "2 Timothy": 4, "Titus": 3, "Philemon": 1, "Hebrews": 13, "James": 5, "1 Peter": 5, "2 Peter": 3, "1 John": 5, "2 John": 1, "3 John": 1, "Jude": 1, "Revelation": 22 };

        // --- Authentication State Management ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                authSection.classList.add('hidden');
                mainAppSection.classList.remove('hidden');
                booksCollectionRef = collection(db, `users/${userId}/books`);
                mentorsCollectionRef = collection(db, `users/${userId}/mentors`);
                highlightsCollectionRef = collection(db, `users/${userId}/highlights`);
                loadBooks();
                loadMentors();
                initializeBibleReader();
            } else {
                userId = null;
                mainAppSection.classList.add('hidden');
                authSection.classList.remove('hidden');
                if (unsubscribeBooks) unsubscribeBooks();
                if (unsubscribeMentors) unsubscribeMentors();
                allBooks = []; allMentors = [];
            }
        });

        // --- Event Listeners ---
        document.addEventListener('mousemove', e => spotlight.style.setProperty('--x', e.clientX + 'px') && spotlight.style.setProperty('--y', e.clientY + 'px'));
        document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); });
        document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });
        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try { await signInWithEmailAndPassword(auth, email, password); showToast("Logged in successfully!"); } catch (error) { showToast(`Error: ${error.message}`); }
        });
        document.getElementById('register-btn').addEventListener('click', async () => {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            try { await createUserWithEmailAndPassword(auth, email, password); showToast("Registered successfully!"); } catch (error) { showToast(`Error: ${error.message}`); }
        });
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try { await signOut(auth); showToast("Logged out."); } catch (error) { showToast(`Error: ${error.message}`); }
        });
        booksTab.addEventListener('click', () => switchTab('books'));
        mentorsTab.addEventListener('click', () => switchTab('mentors'));
        scripturesTab.addEventListener('click', () => switchTab('scriptures'));
        bookSearchBtn.addEventListener('click', handleBookSearch);
        bookSearchInput.addEventListener('keypress', e => e.key === 'Enter' && handleBookSearch());
        document.getElementById('cancel-edit-book-btn').addEventListener('click', () => editBookModal.classList.add('hidden'));
        document.getElementById('save-edit-book-btn').addEventListener('click', saveBookChanges);
        mentorSearchBtn.addEventListener('click', handleMentorSearch);
        mentorSearchInput.addEventListener('keypress', e => e.key === 'Enter' && handleMentorSearch());
        document.getElementById('cancel-edit-mentor-btn').addEventListener('click', () => editMentorModal.classList.add('hidden'));
        document.getElementById('save-edit-mentor-btn').addEventListener('click', saveMentorChanges);
        document.getElementById('cancel-confirm-btn').addEventListener('click', () => confirmModal.classList.add('hidden'));
        document.getElementById('confirm-action-btn').addEventListener('click', () => { if (confirmAction) confirmAction(); confirmModal.classList.add('hidden'); });
        
        // Bible Reader Listeners
        bibleVersionSelect.addEventListener('change', () => {
             if (scriptureState.view === 'text') {
                fetchChapter(scriptureState.book, scriptureState.chapter);
             }
        });
        bibleBackBtn.addEventListener('click', handleBibleBack);
        
        // Highlighting Listeners
        bibleTextContent.addEventListener('mouseup', handleTextSelection);
        bibleTextContent.addEventListener('click', handleHighlightClick);
        highlightBtn.addEventListener('click', createHighlight);
        removeHighlightBtn.addEventListener('click', removeHighlight);
        document.addEventListener('click', (e) => { // Hide popover on outside click
            if (!highlightPopover.contains(e.target)) {
                highlightPopover.style.display = 'none';
            }
        });

        // --- Tab Management ---
        function switchTab(tab) {
            booksSection.classList.add('hidden');
            mentorsSection.classList.add('hidden');
            scripturesSection.classList.add('hidden');
            [booksTab, mentorsTab, scripturesTab].forEach(t => t.classList.remove('active'));
            if (tab === 'books') { booksSection.classList.remove('hidden'); booksTab.classList.add('active'); }
            else if (tab === 'mentors') { mentorsSection.classList.remove('hidden'); mentorsTab.classList.add('active'); }
            else if (tab === 'scriptures') { scripturesSection.classList.remove('hidden'); scripturesTab.classList.add('active'); }
        }

        // --- AI Search Handlers ---
        async function handleBookSearch() { await handleSearch(bookSearchInput, bookSearchBtn, findBooksWithAI, addAndRenderBook); }
        async function handleMentorSearch() { await handleSearch(mentorSearchInput, mentorSearchBtn, findMentorsWithAI, addAndRenderMentor); }
        async function handleSearch(inputEl, btnEl, findFn, addFn) {
            const rawQuery = inputEl.value.trim();
            if (!rawQuery) return;
            toggleLoading(btnEl, true);
            const addCommandRegex = /^(?:add|generate)\s+(\d+)\s+(.+)/i;
            const match = rawQuery.match(addCommandRegex);
            let items = [];
            try {
                if (match) {
                    const quantity = parseInt(match[1], 10);
                    const topic = match[2];
                    items = await findFn(`Find ${quantity} ${topic}`, quantity);
                } else {
                    items = await findFn(`Find up to 3 items about: ${rawQuery}`);
                }
                if (items && items.length > 0) {
                    for (const item of items) { await addFn(item); }
                    showToast(`${items.length} item(s) added successfully!`);
                } else {
                    showToast("No items found for your query.");
                }
                inputEl.value = '';
            } catch (error) {
                console.error("Error finding items:", error);
                showToast("Sorry, there was an error during the search.");
            } finally {
                toggleLoading(btnEl, false);
            }
        }

        // --- AI API Calls ---
        async function findBooksWithAI(prompt, quantity = 3) {
            const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { "title": { "type": "STRING" }, "author": { "type": "STRING" }, "genre": { "type": "STRING" }, "topic": { "type": "STRING" }, "description": { "type": "STRING" } }, required: ["title", "author", "genre", "topic", "description"] } };
            return callGeminiAPI(`Find ${quantity} books based on this query: "${prompt}". For each book, provide: title, author, genre (a single, simple category like 'Psychology'), topic (a more specific subject), and a brief one-sentence description.`, schema);
        }
        async function findMentorsWithAI(prompt, quantity = 3) {
            const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { "name": { "type": "STRING" }, "field": { "type": "STRING" }, "bio": { "type": "STRING" } }, required: ["name", "field", "bio"] } };
            return callGeminiAPI(`Find ${quantity} mentors based on this query: "${prompt}". The field should be a single, simple category (e.g., 'Technology', 'Art', 'Business'). Also include a brief, one-sentence bio for each mentor.`, schema);
        }
        async function callGeminiAPI(prompt, responseSchema) {
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema } };
            const apiKey = "AIzaSyB1V_RlwAsN-bADGazOVzOEkn5P3K-VakU"; // User's API Key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]) { return JSON.parse(result.candidates[0].content.parts[0].text); }
                console.warn("No valid candidates found in AI response.", result);
                return [];
            } catch (error) { console.error("Error calling Gemini API:", error); return []; }
        }

        // --- Book Functions ---
        function loadBooks() {
            if (!userId) return;
            if (unsubscribeBooks) unsubscribeBooks();
            unsubscribeBooks = onSnapshot(query(booksCollectionRef), snapshot => {
                allBooks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFilterButtons(bookCategoryFilters, allBooks, 'genre', filterBooksByGenre);
                filterBooksByGenre(document.querySelector('#book-category-filters .filter-btn.active')?.dataset.filter || 'all');
            });
        }
        async function addAndRenderBook(book) {
            const sanitizedGenre = book.genre ? book.genre.trim().toLowerCase() : 'uncategorized';
            await addDoc(booksCollectionRef, { 
                title: book.title, 
                author: book.author, 
                genre: sanitizedGenre, 
                topic: book.topic || '',
                description: book.description || '',
                read: false, 
                createdAt: new Date() 
            });
        }
        function filterBooksByGenre(genre) { renderList(bookList, allBooks, genre, 'genre', renderBookCard); }
        function renderBookCard(book) {
            const card = createCardElement(book, book.read ? 'border-green-500' : 'border-indigo-500');
            card.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold mb-1 text-gray-900">${book.title}</h3>
                    <p class="text-gray-700 mb-2 text-sm">by ${book.author}</p>
                    <p class="text-xs font-semibold uppercase tracking-wider text-indigo-600 mb-2">${book.topic || 'General'}</p>
                    <p class="text-gray-600 text-sm mb-4">${book.description || 'No description available.'}</p>
                </div>
                <div class="flex justify-end items-center gap-2 mt-auto">
                    <button class="toggle-read-btn text-sm font-medium ${book.read ? 'text-yellow-600 hover:text-yellow-700' : 'text-green-600 hover:text-green-700'}">${book.read ? 'Mark Unread' : 'Mark Read'}</button>
                    <button class="edit-btn p-2 text-gray-500 hover:text-indigo-600">${getIconSVG('edit')}</button>
                    <button class="delete-btn p-2 text-gray-500 hover:text-red-600">${getIconSVG('delete')}</button>
                </div>`;
            card.querySelector('.toggle-read-btn').addEventListener('click', () => updateDoc(doc(booksCollectionRef, book.id), { read: !book.read }));
            card.querySelector('.edit-btn').addEventListener('click', () => openEditBookModal(book));
            card.querySelector('.delete-btn').addEventListener('click', () => showConfirmModal('delete this book', () => deleteDoc(doc(booksCollectionRef, book.id))));
            return card;
        }
        function openEditBookModal(book) {
            document.getElementById('edit-book-id').value = book.id;
            document.getElementById('edit-book-title').value = book.title;
            document.getElementById('edit-book-author').value = book.author;
            document.getElementById('edit-book-genre').value = book.genre;
            document.getElementById('edit-book-topic').value = book.topic || '';
            document.getElementById('edit-book-description').value = book.description || '';
            editBookModal.classList.remove('hidden');
        }
        async function saveBookChanges() {
            const id = document.getElementById('edit-book-id').value;
            const data = { 
                title: document.getElementById('edit-book-title').value, 
                author: document.getElementById('edit-book-author').value, 
                genre: document.getElementById('edit-book-genre').value.trim().toLowerCase() || 'uncategorized',
                topic: document.getElementById('edit-book-topic').value,
                description: document.getElementById('edit-book-description').value
            };
            await updateDoc(doc(booksCollectionRef, id), data);
            editBookModal.classList.add('hidden');
            showToast("Book updated successfully!");
        }

        // --- Mentor Functions ---
        function loadMentors() {
            if (!userId) return;
            if (unsubscribeMentors) unsubscribeMentors();
            unsubscribeMentors = onSnapshot(query(mentorsCollectionRef), snapshot => {
                allMentors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFilterButtons(mentorFieldFilters, allMentors, 'field', filterMentorsByField);
                filterMentorsByField(document.querySelector('#mentor-field-filters .filter-btn.active')?.dataset.filter || 'all');
            });
        }
        async function addAndRenderMentor(mentor) {
            const sanitizedField = mentor.field ? mentor.field.trim().toLowerCase() : 'uncategorized';
            await addDoc(mentorsCollectionRef, { name: mentor.name, field: sanitizedField, bio: mentor.bio || '', createdAt: new Date() });
        }
        function filterMentorsByField(field) { renderList(mentorList, allMentors, field, 'field', renderMentorCard); }
        function renderMentorCard(mentor) {
            const card = createCardElement(mentor, 'border-purple-500');
            card.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold mb-1 text-gray-900">${mentor.name}</h3>
                    <p class="text-gray-600 text-sm italic mb-3 capitalize">${mentor.field}</p>
                    <p class="text-gray-700 text-sm">${mentor.bio || ''}</p>
                </div>
                <div class="flex justify-end items-center gap-2 mt-auto">
                    <button class="edit-btn p-2 text-gray-500 hover:text-indigo-600">${getIconSVG('edit')}</button>
                    <button class="delete-btn p-2 text-gray-500 hover:text-red-600">${getIconSVG('delete')}</button>
                </div>`;
            card.querySelector('.edit-btn').addEventListener('click', () => openEditMentorModal(mentor));
            card.querySelector('.delete-btn').addEventListener('click', () => showConfirmModal('delete this mentor', () => deleteDoc(doc(mentorsCollectionRef, mentor.id))));
            return card;
        }
        function openEditMentorModal(mentor) {
            document.getElementById('edit-mentor-id').value = mentor.id;
            document.getElementById('edit-mentor-name').value = mentor.name;
            document.getElementById('edit-mentor-field').value = mentor.field;
            document.getElementById('edit-mentor-bio').value = mentor.bio || '';
            editMentorModal.classList.remove('hidden');
        }
        async function saveMentorChanges() {
            const id = document.getElementById('edit-mentor-id').value;
            const data = { name: document.getElementById('edit-mentor-name').value, field: document.getElementById('edit-mentor-field').value.trim().toLowerCase() || 'uncategorized', bio: document.getElementById('edit-mentor-bio').value };
            await updateDoc(doc(mentorsCollectionRef, id), data);
            editMentorModal.classList.add('hidden');
            showToast("Mentor updated successfully!");
        }
        
        // --- Scripture (Bible Reader) Functions ---
        function initializeBibleReader() {
            renderBookGrid();
        }

        function renderBookGrid() {
            scriptureState = { view: 'books', book: null, chapter: null };
            updateScriptureView();
            bibleBookGrid.innerHTML = '';
            for (const bookName in bibleBooks) {
                const card = document.createElement('div');
                card.className = 'scripture-card cursor-pointer p-4 bg-white rounded-lg shadow text-center font-semibold text-gray-700';
                card.textContent = bookName;
                card.addEventListener('click', () => renderChapterGrid(bookName));
                bibleBookGrid.appendChild(card);
            }
        }
        
        function renderChapterGrid(bookName) {
            scriptureState = { view: 'chapters', book: bookName, chapter: null };
            updateScriptureView();
            const chapterCount = bibleBooks[bookName];
            bibleChapterGrid.innerHTML = '';
            for (let i = 1; i <= chapterCount; i++) {
                const card = document.createElement('div');
                card.className = 'scripture-card cursor-pointer flex items-center justify-center h-12 w-12 bg-white rounded-lg shadow font-semibold text-gray-700';
                card.textContent = i;
                card.addEventListener('click', () => fetchChapter(bookName, i));
                bibleChapterGrid.appendChild(card);
            }
        }
        
        async function fetchChapter(book, chapter) {
            scriptureState = { view: 'text', book: book, chapter: chapter };
            updateScriptureView();
            const version = bibleVersionSelect.value;
            bibleTextContent.innerHTML = `<div class="text-center">Loading...</div>`;
            try {
                const response = await fetch(`https://bible-api.com/${book} ${chapter}?translation=${version}`);
                if (!response.ok) throw new Error('Bible API request failed.');
                const data = await response.json();
                bibleTextContent.innerHTML = data.verses.map(verse => `<p><sup data-verse="${verse.verse}">${verse.verse}</sup> ${verse.text.trim()}</p>`).join('');
                await loadAndApplyHighlights(version, book, chapter);
            } catch (error) {
                console.error("Error fetching Bible chapter:", error);
                bibleTextContent.innerHTML = `<div class="text-center text-red-500">Could not load chapter. Please try again later.</div>`;
                showToast("Failed to load scripture text.");
            }
        }

        function handleBibleBack() {
            if (scriptureState.view === 'text') {
                renderChapterGrid(scriptureState.book);
            } else if (scriptureState.view === 'chapters') {
                renderBookGrid();
            }
        }

        function updateScriptureView() {
            bibleBookGrid.classList.toggle('hidden', scriptureState.view !== 'books');
            bibleChapterGrid.classList.toggle('hidden', scriptureState.view !== 'chapters');
            bibleTextContainer.classList.toggle('hidden', scriptureState.view !== 'text');
            bibleBackBtn.classList.toggle('hidden', scriptureState.view === 'books');

            if (scriptureState.view === 'books') scriptureViewTitle.textContent = 'The Bible';
            else if (scriptureState.view === 'chapters') scriptureViewTitle.textContent = scriptureState.book;
            else if (scriptureState.view === 'text') scriptureViewTitle.textContent = `${scriptureState.book} ${scriptureState.chapter}`;
        }

        // --- Highlighting Functions ---
        function handleTextSelection(e) {
            const selection = window.getSelection();
            if (!selection.isCollapsed) {
                const range = selection.getRangeAt(0);
                if (!bibleTextContent.contains(range.commonAncestorContainer)) return;
                
                const rect = range.getBoundingClientRect();
                const containerRect = bibleTextContent.getBoundingClientRect();
                
                highlightPopover.style.top = `${rect.top - containerRect.top - highlightPopover.offsetHeight - 5}px`;
                highlightPopover.style.left = `${rect.left - containerRect.left + rect.width / 2 - highlightPopover.offsetWidth / 2}px`;
                highlightPopover.style.display = 'block';
                highlightBtn.style.display = 'block';
                removeHighlightBtn.style.display = 'none';
            } else {
                 if (!e.target.closest('mark')) {
                    highlightPopover.style.display = 'none';
                }
            }
        }
        function handleHighlightClick(e) {
            if (e.target.tagName === 'MARK') {
                currentHighlightTarget = e.target;
                const rect = e.target.getBoundingClientRect();
                const containerRect = bibleTextContent.getBoundingClientRect();
                highlightPopover.style.top = `${rect.top - containerRect.top - highlightPopover.offsetHeight - 5}px`;
                highlightPopover.style.left = `${rect.left - containerRect.left + rect.width / 2 - highlightPopover.offsetWidth / 2}px`;
                highlightPopover.style.display = 'block';
                highlightBtn.style.display = 'none';
                removeHighlightBtn.style.display = 'block';
            }
        }
        async function createHighlight() {
            const selection = window.getSelection();
            if (selection.isCollapsed) return;
            const range = selection.getRangeAt(0);
            
            const startVerseEl = range.startContainer.parentElement.closest('p')?.querySelector('sup');
            const endVerseEl = range.endContainer.parentElement.closest('p')?.querySelector('sup');
            if (!startVerseEl || !endVerseEl) return;

            const startVerse = parseInt(startVerseEl.dataset.verse);
            const endVerse = parseInt(endVerseEl.dataset.verse);
            
            const highlightData = {
                version: bibleVersionSelect.value,
                book: scriptureState.book,
                chapter: scriptureState.chapter,
                startVerse,
                endVerse,
                startOffset: getOffset(startVerseEl.parentElement, range.startContainer, range.startOffset),
                endOffset: getOffset(endVerseEl.parentElement, range.endContainer, range.endOffset),
                text: range.toString(),
                createdAt: new Date()
            };
            
            try {
                await addDoc(highlightsCollectionRef, highlightData);
                highlightPopover.style.display = 'none';
                fetchChapter(scriptureState.book, scriptureState.chapter); // Re-fetch to apply the new highlight correctly
                showToast("Highlight saved!");
            } catch(error) {
                console.error("Error saving highlight:", error);
                showToast("Failed to save highlight.");
            }
        }
        async function removeHighlight() {
            if (!currentHighlightTarget) return;
            const highlightId = currentHighlightTarget.dataset.highlightId;
            if (highlightId) {
                try {
                    await deleteDoc(doc(highlightsCollectionRef, highlightId));
                    // Visually remove it immediately
                    const parent = currentHighlightTarget.parentNode;
                    while (currentHighlightTarget.firstChild) {
                        parent.insertBefore(currentHighlightTarget.firstChild, currentHighlightTarget);
                    }
                    parent.removeChild(currentHighlightTarget);
                    parent.normalize(); // Merges adjacent text nodes
                    highlightPopover.style.display = 'none';
                    showToast("Highlight removed.");
                } catch (error) {
                    console.error("Error removing highlight:", error);
                    showToast("Failed to remove highlight.");
                }
            }
        }
        async function loadAndApplyHighlights(version, book, chapter) {
            const q = query(highlightsCollectionRef, where("version", "==", version), where("book", "==", book), where("chapter", "==", parseInt(chapter)));
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach(doc => {
                applyHighlight(doc.id, doc.data());
            });
        }
        function applyHighlight(id, data) {
            try {
                const startNode = findNodeByVerseAndOffset(data.startVerse, data.startOffset);
                const endNode = findNodeByVerseAndOffset(data.endVerse, data.endOffset);
                if (startNode && endNode) {
                    const range = document.createRange();
                    range.setStart(startNode.node, startNode.offset);
                    range.setEnd(endNode.node, endNode.offset);
                    const mark = document.createElement('mark');
                    mark.dataset.highlightId = id;
                    range.surroundContents(mark);
                }
            } catch (error) {
                console.error("Could not apply highlight:", data, error);
            }
        }
        function getOffset(parent, node, offset) {
            let precedingLength = 0;
            const treeWalker = document.createTreeWalker(parent, NodeFilter.SHOW_TEXT);
            while (treeWalker.nextNode() && treeWalker.currentNode !== node) {
                precedingLength += treeWalker.currentNode.textContent.length;
            }
            return precedingLength + offset;
        }
        function findNodeByVerseAndOffset(verse, targetOffset) {
            const verseEl = bibleTextContent.querySelector(`sup[data-verse="${verse}"]`);
            if (!verseEl) return null;
            const parentP = verseEl.parentElement;
            let accumulatedOffset = 0;
            const treeWalker = document.createTreeWalker(parentP, NodeFilter.SHOW_TEXT);
            while (treeWalker.nextNode()) {
                const currentNode = treeWalker.currentNode;
                const nodeLength = currentNode.textContent.length;
                if (accumulatedOffset + nodeLength >= targetOffset) {
                    return { node: currentNode, offset: targetOffset - accumulatedOffset };
                }
                accumulatedOffset += nodeLength;
            }
            return null;
        }

        // --- Generic UI Functions ---
        function renderFilterButtons(container, items, property, filterFn) {
            const currentActive = container.querySelector('.filter-btn.active')?.dataset.filter || 'all';
            const filters = ['all', ...new Set(items.map(item => item[property] || 'uncategorized').sort())];
            container.innerHTML = filters.map(filter => {
                const isActive = filter === currentActive;
                return `<button class="filter-btn px-3 py-1 border border-gray-300 rounded-full text-sm font-medium hover:bg-gray-200 transition-colors bg-white ${isActive ? 'active' : ''}" data-filter="${filter}">${filter.charAt(0).toUpperCase() + filter.slice(1)}</button>`;
            }).join('');
            container.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const currentActiveBtn = container.querySelector('.filter-btn.active');
                    if(currentActiveBtn) currentActiveBtn.classList.remove('active');
                    btn.classList.add('active');
                    filterFn(btn.dataset.filter);
                });
            });
        }
        function renderList(container, allItems, filter, property, renderFn) {
            container.innerHTML = '';
            const filtered = filter === 'all' ? allItems : allItems.filter(item => (item[property] || 'uncategorized') === filter);
            filtered.forEach(item => container.appendChild(renderFn(item)));
        }
        function createCardElement(item, borderColor) {
            const card = document.createElement('div');
            card.className = `bg-white/95 backdrop-blur-sm p-6 rounded-lg shadow-lg flex flex-col justify-between card-enter border-l-4 ${borderColor}`;
            card.dataset.id = item.id;
            return card;
        }
        function getIconSVG(type) {
            const icons = {
                edit: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"/></svg>',
                delete: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>'
            };
            return icons[type];
        }
        function showConfirmModal(actionText, callback) {
            confirmMessage.textContent = `Do you really want to ${actionText}? This cannot be undone.`;
            confirmAction = callback;
            confirmModal.classList.remove('hidden');
        }
        function showToast(message) {
            toastMessage.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        function toggleLoading(btn, isLoading) {
            btn.disabled = isLoading;
            btn.querySelector('.loading-spinner').classList.toggle('hidden', !isLoading);
            btn.querySelector('.search-icon').classList.toggle('hidden', isLoading);
            btn.querySelector('.search-btn-text').textContent = isLoading ? 'Searching...' : 'Search';
        }
    </script>
</body>
</html>
